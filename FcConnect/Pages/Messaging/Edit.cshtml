@page
@model FcConnect.Pages.Messaging.EditModel

@{
    ViewData["Title"] = "Edit";
  //  string userId = Request.Query["sender"];
  string dateTimeSent = "";

}

<div class="container mb-5">
@foreach (var message in Model.Conversation.Messages)
{
    if (message.DateTimeSent.Date == DateTime.Today)
    {
        dateTimeSent = message.DateTimeSent.ToString("HH:mm");
    }
    else
    {
        dateTimeSent = message.DateTimeSent.ToString("dd/MM/yyyy HH:mm");

    }
    if (Model.userId == message.Sender.Id.ToString())
    {
        <div class="row">            
            <div class="col">
                <div class="alert alert-success" style="border-radius:40px; border-bottom-right-radius:5px; word-wrap: break-word; max-width:fit-content;">
                    <p class="fw-lighter" style="text-align: center; margin-bottom: 8px;">@dateTimeSent</p>
                    <h6 class="alert-heading">@Html.DisplayFor(modelItem => message.Sender.Forename) @Html.DisplayFor(modelItem => message.Sender.Surname)</h6>
                    <p class="mb-0">@Html.DisplayFor(modelItem => message.MessageContent)</p>
                </div>
            </div>
            <div class="col"></div>
        </div>
    }
    else
    {
        <div class="row">
                <div class="col"></div>
            <div class="col d-flex justify-content-end">
                    <div class="alert alert-primary mw-75" style="border-radius:40px; border-bottom-left-radius:5px; word-wrap: break-word; max-width:fit-content;">
                    <p class="fw-lighter" style="text-align: center; margin-bottom: 8px;">@dateTimeSent</p>
                    <h6 class="alert-heading">@Html.DisplayFor(modelItem => message.Sender.Forename) @Html.DisplayFor(modelItem => message.Sender.Surname)</h6> 
                    <p class="mb-0">@Html.DisplayFor(modelItem => message.MessageContent)</p>
                </div>
            </div>
        </div>
    }
}
<div id="focus"></div>
</div>
<div class="container mt-5 fixed-bottom bg-white">
    <div class="row">
        <div class="col">
            <form method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <input type="hidden" asp-for="Conversation.Id" />
                <input type="hidden" asp-for="Conversation.LastMessageSent" class="form-control" />
                <div class="row justify-content-center pb-2 pt-4" style="background-color: #f5f7f9; border-top-left-radius: 10px; border-top-right-radius: 10px;">
                    <div class="col-sm-12 col-md-6">
                        <div class="input-group">
                            <input asp-for="NewMessageText" class="form-control" id="messageTextField" type="text" placeholder="New Message..." />
                            <div class="input-group-append">
                                <button type="submit" id="sendButton" class="btn btn-primary"><i class="bi bi-send-fill"></i> &nbsp;Send</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col d-flex justify-content-center">
                            <span class="pt-3 pb-1" asp-validation-for="NewMessageText"></span>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

</div>


@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    
    <script>
        // reload page on message send
        $(function () {
            $('form').submit(function (e) {
                e.preventDefault(); 
                $.post($(this).attr('action'), $(this).serialize(), function (data) {
                    if (data.success) {
                        location.reload(); 
                    } else {
                        
                    }
                });
            });
        });

        $(function () {
            // Refresh page function
            function refreshPage() {
                // check user isn't typing
                var inputText = $('#messageTextField').val();
                if (inputText === null || inputText.length === 0 && !$('#messageTextField').is(':focus')) {
                    location.reload();
                }
            }

            // Refresh every 10 seconds
            setInterval(refreshPage, 10000);
        });
    </script>
}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        window.scrollTo(0, document.body.scrollHeight);

        // Hide the footer if needed
        document.querySelector("footer").style.visibility = "hidden";
    });
</script>
